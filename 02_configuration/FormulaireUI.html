<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .hidden-section { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out, opacity 0.3s ease-out; opacity: 0; }
      .visible-section { max-height: 500px; opacity: 1; transition: max-height 0.5s ease-in, opacity 0.5s ease-in; }
    </style>
  </head>
  <body class="bg-gray-100 p-4 font-sans">
    <div id="main-form">
      <h1 class="text-xl font-bold text-gray-800 mb-4">Configurer un Nouveau Test</h1>

      <div class="mb-4">
        <label for="titreTest" class="block text-sm font-medium text-gray-700">Titre du Test (pour l'utilisateur)</label>
        <input type="text" id="titreTest" name="titreTest" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
      </div>

      <div class="mb-4">
        <label for="typeTest" class="block text-sm font-medium text-gray-700">Type de Test</label>
        <select id="typeTest" name="typeTest" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
          <option value="">Chargement...</option>
        </select>
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Questions Standards (Blocs Méta)</label>
        <div id="meta-blocks-container" class="mt-2 p-3 bg-white border border-gray-300 rounded-md space-y-2">
          <p class="text-xs text-gray-500">Chargement des options...</p>
        </div>
      </div>

      <div id="questions-info" class="mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-md hidden">
        <p class="text-sm text-indigo-700">Nombre de questions disponibles : <span id="question-count" class="font-bold">...</span></p>
      </div>

      <div class="mb-4">
        <label for="nbQuestions" class="block text-sm font-medium text-gray-700">Nombre de questions à utiliser</label>
        <input type="number" id="nbQuestions" name="nbQuestions" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
      </div>

      <hr class="my-6">

      <div class="mb-2">
        <label class="flex items-center">
          <input type="checkbox" id="sendEmailRepondant" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
          <span class="ml-2 text-sm text-gray-700">Envoyer un email au répondant ?</span>
        </label>
      </div>
      <div id="detailsRepondant" class="pl-6 border-l-2 border-gray-200 ml-2 mb-4 hidden-section"></div>

      <div class="mb-2">
        <label class="flex items-center">
          <input type="checkbox" id="sendEmailPatron" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
          <span class="ml-2 text-sm text-gray-700">Envoyer un email au patron ?</span>
        </label>
      </div>
      <div id="detailsPatron" class="pl-6 border-l-2 border-gray-200 ml-2 mb-4 hidden-section"></div>

      <div class="mb-2">
        <label class="flex items-center">
          <input type="checkbox" id="sendEmailFormateur" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
          <span class="ml-2 text-sm text-gray-700">Envoyer un email au formateur ?</span>
        </label>
      </div>
      <div id="detailsFormateur" class="pl-6 border-l-2 border-gray-200 ml-2 mb-4 hidden-section"></div>

      <hr class="my-6">

      <div class="mb-4">
        <label for="emailAlias" class="block text-sm font-medium text-gray-700">Alias d'expédition (optionnel)</label>
        <input type="email" id="emailAlias" name="emailAlias" placeholder="contact@mon-entreprise.com" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
      </div>

      <div class="mb-4">
        <label for="emailDev" class="block text-sm font-medium text-gray-700">Email du Développeur (notifications)</label>
        <input type="email" id="emailDev" name="emailDev" placeholder="Défaut : chanenam@gmail.com" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
      </div>

      <button id="submit-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400">
        Créer la Configuration
      </button>
    </div>

    <div id="feedback-screen" class="hidden text-center py-10">
      <p id="feedback-message" class="text-lg text-gray-700"></p>
    </div>

    <script>
      // --- INITIALISATION & GESTION DYNAMIQUE ---
      document.addEventListener('DOMContentLoaded', function() {
        google.script.run.withSuccessHandler(populateInitialData).getInitialData();
        setupEventListeners();
      });

      function populateInitialData(data) {
        // Type de test
        const typeTestSelect = document.getElementById('typeTest');
        typeTestSelect.innerHTML = '<option value="">-- Choisissez un type --</option>';
        (data.typesDeTest || []).forEach(type => {
          const option = document.createElement('option');
          option.value = type; option.textContent = type;
          typeTestSelect.appendChild(option);
        });
        
        // Blocs méta
        const metaContainer = document.getElementById('meta-blocks-container');
        if (data.availableMetaBlocks && data.availableMetaBlocks.length > 0) {
          metaContainer.innerHTML = '';
          data.availableMetaBlocks.forEach(block => {
            const isChecked = (block.id === 'META_EMAIL' || block.id === 'META_NOM_COMPLET');
            const label = document.createElement('label');
            label.className = 'flex items-center text-sm text-gray-800';
            label.innerHTML = `
              <input type="checkbox" value="${block.id}" class="meta-block-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${isChecked ? 'checked' : ''}>
              <span class="ml-2">${block.title}</span>
            `;
            metaContainer.appendChild(label);
          });
        } else {
          metaContainer.innerHTML = '<p class="text-xs text-gray-500">Aucun bloc méta trouvé dans la BDD.</p>';
        }

        // Zones emails
        populateEmailOptions('detailsRepondant', 'Repondant', data.options || {});
        populateEmailOptions('detailsPatron', 'Patron', data.options || {});
        populateEmailOptions('detailsFormateur', 'Formateur', data.options || {});
      }

      function setupEventListeners() {
        document.getElementById('typeTest').addEventListener('change', function() {
          const selectedType = this.value;
          const infoDiv = document.getElementById('questions-info');
          const countSpan = document.getElementById('question-count');

          if (selectedType) {
            infoDiv.classList.remove('hidden');
            countSpan.textContent = 'Chargement...';
            google.script.run.withSuccessHandler(updateQuestionCount).getQuestionCountForTestType(selectedType);
          } else {
            infoDiv.classList.add('hidden');
          }
        });

        setupEmailSectionToggle('sendEmailRepondant', 'detailsRepondant');
        setupEmailSectionToggle('sendEmailPatron', 'detailsPatron');
        setupEmailSectionToggle('sendEmailFormateur', 'detailsFormateur');

        document.getElementById('submit-button').addEventListener('click', submitForm);
      }

      function submitForm(e) {
        e.preventDefault();
        if (!document.getElementById('titreTest').value || !document.getElementById('typeTest').value || !document.getElementById('nbQuestions').value) {
          alert('Veuillez remplir tous les champs obligatoires (Titre, Type, Nombre de questions).');
          return;
        }
        
        const selectedMetaBlocks = [];
        document.querySelectorAll('.meta-block-checkbox:checked').forEach(checkbox => {
          selectedMetaBlocks.push(checkbox.value);
        });

        const formObject = {
          titre: document.getElementById('titreTest').value,
          type: document.getElementById('typeTest').value,
          blocsMeta: selectedMetaBlocks,
          nbQuestions: document.getElementById('nbQuestions').value,

          repondantActif: document.getElementById('sendEmailRepondant').checked,
          repondantQuand: document.getElementById('sendEmailRepondant').checked ? document.getElementById('quandRepondant').value : '',
          repondantContenu: document.getElementById('sendEmailRepondant').checked ? document.getElementById('contenuRepondant').value : '',

          patronActif: document.getElementById('sendEmailPatron').checked,
          patronEmail: document.getElementById('sendEmailPatron').checked ? document.getElementById('emailPatron').value : '',
          patronQuand: document.getElementById('sendEmailPatron').checked ? document.getElementById('quandPatron').value : '',
          patronContenu: document.getElementById('sendEmailPatron').checked ? document.getElementById('contenuPatron').value : '',

          formateurActif: document.getElementById('sendEmailFormateur').checked,
          formateurEmail: document.getElementById('sendEmailFormateur').checked ? document.getElementById('emailFormateur').value : '',
          formateurQuand: document.getElementById('sendEmailFormateur').checked ? document.getElementById('quandFormateur').value : '',
          formateurContenu: document.getElementById('sendEmailFormateur').checked ? document.getElementById('contenuFormateur').value : '',

          devEmail: document.getElementById('emailDev').value,
          emailAlias: document.getElementById('emailAlias').value.trim()
        };

        showFeedbackScreen('Enregistrement en cours...');
        document.getElementById('submit-button').disabled = true;
        google.script.run
          .withSuccessHandler(onSaveSuccess)
          .withFailureHandler(onSaveFailure)
          .processNewTestConfiguration(formObject);
      }
      
      // --- FONCTIONS UTILITAIRES ---
      function populateEmailOptions(containerId, prefix, options) {
        const container = document.getElementById(containerId);
        let html = '';

        if (prefix === 'Patron' || prefix === 'Formateur') {
          html += `
            <div class="mt-2 mb-3">
              <label for="email${prefix}" class="block text-sm font-medium text-gray-600">Adresse e-mail du ${prefix}</label>
              <input type="email" id="email${prefix}" class="mt-1 block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>`;
        }

        const arrQuand = options[`${prefix}_Quand`] || [];
        const arrContenu = options[`${prefix}_Contenu`] || [];

        html += `
          <div class="mt-2 mb-3">
            <label for="quand${prefix}" class="block text-sm font-medium text-gray-600">Quand envoyer l'email ?</label>
            <select id="quand${prefix}" class="mt-1 block w-full pl-2 pr-8 py-1.5 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
              ${arrQuand.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
            </select>
          </div>
          <div class="mt-2 mb-3">
            <label for="contenu${prefix}" class="block text-sm font-medium text-gray-600">Quel niveau de contenu ?</label>
            <select id="contenu${prefix}" class="mt-1 block w-full pl-2 pr-8 py-1.5 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
              ${arrContenu.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
            </select>
          </div>`;

        container.innerHTML = html;
      }

      function updateQuestionCount(count) {
        document.getElementById('question-count').textContent = count;
      }

      function setupEmailSectionToggle(checkboxId, sectionId) {
        document.getElementById(checkboxId).addEventListener('change', function() {
          const section = document.getElementById(sectionId);
          if (this.checked) {
            section.classList.remove('hidden-section');
            section.classList.add('visible-section');
          } else {
            section.classList.remove('visible-section');
            section.classList.add('hidden-section');
          }
        });
      }

      function onSaveSuccess(message) {
        showFeedbackScreen(message);
        setTimeout(function() {
          google.script.host.close();
        }, 2000);
      }

      function onSaveFailure(error) {
        showFeedbackScreen('Erreur : ' + (error?.message || error));
        document.getElementById('submit-button').disabled = false;
      }

      function showFeedbackScreen(message) {
        document.getElementById('main-form').classList.add('hidden');
        const feedbackScreen = document.getElementById('feedback-screen');
        document.getElementById('feedback-message').textContent = message;
        feedbackScreen.classList.remove('hidden');
      }
    </script>
  </body>
</html>
