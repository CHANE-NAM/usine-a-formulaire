=== Projet: [CONFIG]V2 Usine Ã  Tests (G:\Mon Drive\APPLI TEST Personnalité Drive\Projet USINE à FORMULAIRE GoogleForm\02_configuration) ===


--- FILE: G:\Mon Drive\APPLI TEST Personnalité Drive\Projet USINE à FORMULAIRE GoogleForm\02_configuration\appsscript.json ---

{
  "timeZone": "Indian/Mauritius",
  "dependencies": {
  },
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8"
}

--- FILE: G:\Mon Drive\APPLI TEST Personnalité Drive\Projet USINE à FORMULAIRE GoogleForm\02_configuration\Menu.js ---

// =================================================================================
// == FICHIER : menu.gs
// == VERSION : 3.6 (Valeur par dÃ©faut "Universel" pour Moteur_Calcul)
// == RÃ”LE  : Logique cÃ´tÃ© serveur pour l'application web de configuration.
// =================================================================================

const ID_FEUILLE_CONFIG = "1kLBqIHZWbHrb4SsoSQcyVsLOmqKHkhSA4FttM5hZtDQ";

// --- SECTION 1 : INTERFACE UTILISATEUR ---

function onOpen() {
  const ui = SpreadsheetApp.getUi();

  // Menu principal unique
  const main = ui.createMenu('ðŸ­ Usine');

  // Sous-menu Configuration
  const conf = ui.createMenu('Configuration')
    .addItem('Configurer un nouveau test...', 'showConfigurationSidebar');

  // Sous-menu Validation (appel de la fonction utilitaire du runner)
  // -> si tu prÃ©fÃ¨res deux top-level menus sÃ©parÃ©s, commente les 3 lignes suivantes
  const val = ui.createMenu('Validation')
    .addItem('VÃ©rifier les en-tÃªtes (CONFIG, BDD, TEMPLATE)', 'validateAllHeaders');

  main.addSubMenu(conf);
  main.addSubMenu(val);
  main.addToUi();
}

function showConfigurationSidebar() {
  const html = HtmlService.createHtmlOutputFromFile('FormulaireUI')
      .setTitle('Configuration Usine Ã  Tests')
      .setWidth(400);
  SpreadsheetApp.getUi().showSidebar(html);
}


// --- SECTION 2 : FONCTIONS APPELÃ‰ES PAR L'INTERFACE HTML ---

function getInitialData() {
  const ss = SpreadsheetApp.openById(ID_FEUILLE_CONFIG);
  const optionsSheet = ss.getSheetByName("sys_Options_Parametres");
  if (!optionsSheet) {
    throw new Error("L'onglet 'sys_Options_Parametres' est introuvable.");
  }

  const optionsData = optionsSheet.getDataRange().getValues();
  const headers = optionsData.shift();
  const optionsMap = {};
  headers.forEach((header, i) => {
    const options = optionsData.map(row => row[i]).filter(String);
    optionsMap[header] = options;
  });

  // Charger la liste des blocs mÃ©ta disponibles depuis la BDD
  let availableMetaBlocks = [];
  try {
    const systemIds = getSystemIds();
    const bdd = SpreadsheetApp.openById(systemIds.ID_BDD);
    const metaSheet = bdd.getSheetByName('Questions_META_FR');
    if (metaSheet) {
        const metaData = metaSheet.getRange(2, 1, metaSheet.getLastRow() - 1, 3).getValues(); // ID, Type, Titre
        availableMetaBlocks = metaData.map(row => ({ id: row[0], title: row[2] })).filter(block => block.id && block.title);
    }
  } catch(e) {
    console.error("Impossible de charger les blocs mÃ©ta depuis la BDD : " + e.message);
  }

  return {
    typesDeTest: optionsMap['Type_Test'] || [],
    availableMetaBlocks: availableMetaBlocks,
    options: {
      Repondant_Quand: optionsMap['Repondant_Quand'] || [],
      Repondant_Contenu: optionsMap['Repondant_Contenu'] || [],
      Patron_Quand: optionsMap['Patron_Quand'] || [],
      Patron_Contenu: optionsMap['Patron_Contenu'] || [],
      Formateur_Quand: optionsMap['Formateur_Quand'] || [],
      Formateur_Contenu: optionsMap['Formateur_Contenu'] || []
    }
  };
}

function getQuestionCountForTestType(typeTest) {
  if (!typeTest) return 0;
  try {
    const systemIds = getSystemIds();
    if (systemIds && systemIds.ID_BDD) {
      const bdd = SpreadsheetApp.openById(systemIds.ID_BDD);
      const questionSheet = bdd.getSheets().find(s => s.getName().startsWith('Questions_' + typeTest));
      if (questionSheet) {
        return questionSheet.getLastRow() - 1;
      }
    }
    return 0;
  } catch (err) {
    Logger.log('Erreur lors du calcul du nombre de questions pour ' + typeTest + ': ' + err.message);
    return 0;
  }
}


// --- SECTION 3 : TRAITEMENT DE LA SOUMISSION ---

function processNewTestConfiguration(formObject) {
  try {
    const ss = SpreadsheetApp.openById(ID_FEUILLE_CONFIG);
    const paramsSheet = ss.getSheetByName("ParamÃ¨tres GÃ©nÃ©raux");
    if (!paramsSheet) { throw new Error("L'onglet 'ParamÃ¨tres GÃ©nÃ©raux' est introuvable."); }
    
    let headers = paramsSheet.getRange(1, 1, 1, paramsSheet.getLastColumn()).getValues()[0];
    
    // ==================== DÃ‰BUT MODIFICATION ====================
    // On s'assure que les colonnes requises, y compris Moteur_Calcul, existent.
    const requiredHeaders = ['Blocs_Meta_A_Inclure', 'ID_Gabarit_Email_Repondant', 'Email_Alias', 'Moteur_Calcul'];
    // ===================== FIN MODIFICATION =====================

    requiredHeaders.forEach(headerName => {
        if (headers.indexOf(headerName) === -1) {
            paramsSheet.getRange(1, paramsSheet.getLastColumn() + 1).setValue(headerName);
        }
    });
    headers = paramsSheet.getRange(1, 1, 1, paramsSheet.getLastColumn()).getValues()[0];
    
    let emailDev = formObject.devEmail;
    if (!emailDev || emailDev.trim() === "") { emailDev = "chanenam@gmail.com"; }

    const limiteLignes = getQuestionCountForTestType(formObject.type);
    const blocsMetaString = formObject.blocsMeta.join(',');

    let idGabaritRepondant = ''; // Valeur par dÃ©faut
    if (formObject.repondantContenu && formObject.repondantContenu.includes('Niveau1')) {
        idGabaritRepondant = 'RESULTATS_N1';
    } else if (formObject.repondantContenu && formObject.repondantContenu.includes('Niveau2')) {
        idGabaritRepondant = 'RESULTATS_N2';
    } else if (formObject.repondantContenu && formObject.repondantContenu.includes('Niveau3')) {
        idGabaritRepondant = 'RESULTATS_N3';
    }

    const dataRow = {
      'Id_Unique': '',
      'Titre_Formulaire_Utilisateur': formObject.titre,
      'Nom_Fichier_Complet': '',
      'Statut': 'En construction',
      'Type_Test': formObject.type,
      // ==================== DÃ‰BUT MODIFICATION ====================
      'Moteur_Calcul': 'Universel', // On force le moteur Universel par dÃ©faut
      // ===================== FIN MODIFICATION =====================
      'Blocs_Meta_A_Inclure': blocsMetaString,
      'ID_Gabarit_Email_Repondant': idGabaritRepondant,
      'ID_Dossier_Cible': '',
      'Limite_Lignes_A_Traiter': limiteLignes,
      'nbQuestions': formObject.nbQuestions,
      'Repondant_Email_Actif': formObject.repondantActif ? "Oui" : "Non",
      'Repondant_Quand': formObject.repondantQuand,
      'Repondant_Contenu': formObject.repondantContenu,
      'Patron_Email_Mode': formObject.patronActif ? "Oui" : "Non",
      'Patron_Quand': formObject.patronQuand,
      'Patron_Contenu': formObject.patronContenu,
      'Patron_Email': formObject.patronEmail,
      'Formateur_Email_Actif': formObject.formateurActif ? "Oui" : "Non",
      'Formateur_Quand': formObject.formateurQuand,
      'Formateur_Contenu': formObject.formateurContenu,
      'Formateur_Email': formObject.formateurEmail,
      'Developpeur_Email': emailDev,
      'ID_Formulaire_Cible': '',
      'ID_Sheet_Cible': '',
      'Email_Alias': formObject.emailAlias
    };
    
    const nouvelleLigne = headers.map(header => dataRow[header] !== undefined ? dataRow[header] : '');
    paramsSheet.appendRow(nouvelleLigne);
    return "Configuration enregistrÃ©e avec succÃ¨s !";
  } catch (e) {
    Logger.log("ERREUR lors de la sauvegarde de la configuration: " + e.toString());
    throw new Error("Une erreur interne est survenue lors de la sauvegarde. " + e.message);
  }
}


// --- SECTION 4 : FONCTIONS UTILITAIRES ---

function getSystemIds() {
  const configSS = SpreadsheetApp.openById(ID_FEUILLE_CONFIG);
  const idSheet = configSS.getSheetByName('sys_ID_Fichiers');
  if (!idSheet) { throw new Error("L'onglet 'sys_ID_Fichiers' est introuvable."); }
  const data = idSheet.getDataRange().getValues();
  const ids = {};
  data.slice(1).forEach(row => {
    if (row[0] && row[1]) ids[row[0]] = row[1];
  });
  return ids;
}

--- FILE: G:\Mon Drive\APPLI TEST Personnalité Drive\Projet USINE à FORMULAIRE GoogleForm\02_configuration\concat_scripts_repvic.js ---

const fs = require('fs');
const path = require('path');

// --- CONFIGURATION ---
// Extensions de fichiers Ã  inclure
const scriptExtensions = [
    '.js', '.ts', '.jsx', '.tsx', '.py', '.html', '.css', '.scss', '.less',
    '.xml', '.php', '.rb', '.java', '.c', '.cpp', '.cs', '.go',
    '.sh', '.ps1', '.bat', '.cmd', '.sql', '.vue', '.svelte', '.astro'
];

// Le dossier Ã  scanner
const folderToScan = './'; // Ã€ ajuster si besoin
// --- FIN CONFIGURATION ---

// RÃ©cupÃ©rer le nom du rÃ©pertoire scannÃ©
const resolvedFolderPath = path.resolve(folderToScan);
const dirName = path.basename(resolvedFolderPath);

// CrÃ©er une date au format aammjj
const now = new Date();
const year = String(now.getFullYear()).slice(2); // 2 derniers chiffres de l'annÃ©e
const month = String(now.getMonth() + 1).padStart(2, '0');
const day = String(now.getDate()).padStart(2, '0');
const dateStamp = `${year}${month}${day}`;

// Nom du fichier de sortie
const outputFileName = `${dirName}_Script_${dateStamp}.txt`;

// CrÃ©er une chaÃ®ne avec date et heure en franÃ§ais
const dateTimeString = `// Fichier gÃ©nÃ©rÃ© le ${now.toLocaleDateString('fr-FR')} Ã  ${now.toLocaleTimeString('fr-FR')}\n\n`;

// Initialiser la variable qui accumulera le contenu
let allContent = dateTimeString;

// Fonction rÃ©cursive
function readFilesRecursively(directory) {
    fs.readdirSync(directory).forEach(file => {
        const absolutePath = path.join(directory, file);
        if (fs.statSync(absolutePath).isDirectory()) {
            readFilesRecursively(absolutePath);
        } else {
            const fileExtension = path.extname(file).toLowerCase();
            // --- MODIFICATION ICI ---
            // On vÃ©rifie l'extension ET on exclut les fichiers commenÃ§ant par 'concat_scripts'
            if (scriptExtensions.includes(fileExtension) && !file.startsWith('concat_scripts')) {
                allContent += `// --- DÃ©but du fichier: ${absolutePath} ---\n`;
                allContent += fs.readFileSync(absolutePath, 'utf8');
                allContent += `\n// --- Fin du fichier: ${absolutePath} ---\n\n`;
            }
        }
    });
}

// Supprimer le fichier de sortie existant
if (fs.existsSync(outputFileName)) {
    fs.unlinkSync(outputFileName);
    console.log(`Ancien fichier '${outputFileName}' supprimÃ©.`);
}

// Lancer le traitement
try {
    readFilesRecursively(folderToScan);
    fs.writeFileSync(outputFileName, allContent, 'utf8');
    console.log(`SuccÃ¨s : Tous les scripts ont Ã©tÃ© exportÃ©s dans '${outputFileName}'`);
} catch (error) {
    console.error(`Erreur lors de la lecture ou de l'Ã©criture des fichiers : ${error.message}`);
}

--- FILE: G:\Mon Drive\APPLI TEST Personnalité Drive\Projet USINE à FORMULAIRE GoogleForm\02_configuration\UtilitaireConversion.js ---

// Remplacez cette variable par l'ID de votre feuille de calcul [CONFIG]V2 Usine Ã  Tests.
// const ID_FEUILLE_CONFIG = "1kLBqIHZWbHrb4SsoSQcyVsLOmqKHkhSA4FttM5hZtDQ";

/**
 * Fonction Ã  usage unique pour convertir toutes les URLs de formulaires existantes
 * dans l'onglet 'ParamÃ¨tres GÃ©nÃ©raux' en leurs versions courtes (forms.gle).
 */
function convertirLiensExistantsEnCourts() {
  const nomOnglet = "ParamÃ¨tres GÃ©nÃ©raux";
  
  try {
    const ss = SpreadsheetApp.openById(ID_FEUILLE_CONFIG);
    const sheet = ss.getSheetByName(nomOnglet);
    
    if (!sheet) {
      throw new Error(`L'onglet "${nomOnglet}" est introuvable.`);
    }
    
    const dataRange = sheet.getDataRange();
    const values = dataRange.getValues();
    const headers = values[0];
    
    // Trouve automatiquement la colonne contenant les liens
    const linkColumnIndex = headers.indexOf("Lien_Formulaire_Public");
    if (linkColumnIndex === -1) {
      throw new Error("La colonne 'Lien_Formulaire_Public' est introuvable.");
    }

    // Boucle sur chaque ligne (en sautant l'en-tÃªte)
    for (let i = 1; i < values.length; i++) {
      const longUrl = values[i][linkColumnIndex];
      
      // Ne traite que les URLs longues et non vides
      if (longUrl && typeof longUrl === 'string' && longUrl.includes("docs.google.com/forms")) {
        // Extrait l'ID du formulaire Ã  partir de l'URL longue
        const formId = longUrl.split('/d/')[1].split('/')[0];
        
        if (formId) {
          // Ouvre le formulaire par son ID et obtient l'URL courte
          const form = FormApp.openById(formId);
          const shortUrl = form.getShortUrl();
          
          // Met Ã  jour la cellule avec la nouvelle URL courte
          // Les indices de range commencent Ã  1, donc i+1 et linkColumnIndex+1
          sheet.getRange(i + 1, linkColumnIndex + 1).setValue(shortUrl);
          Logger.log(`Ligne ${i + 1}: URL convertie pour le formulaire ${formId}`);
        }
      }
    }
    
    SpreadsheetApp.getUi().alert("Conversion terminÃ©e avec succÃ¨s !");
    
  } catch (e) {
    Logger.log(`Erreur lors de la conversion : ${e.toString()}`);
    SpreadsheetApp.getUi().alert(`Une erreur est survenue : ${e.message}`);
  }
}

--- FILE: G:\Mon Drive\APPLI TEST Personnalité Drive\Projet USINE à FORMULAIRE GoogleForm\02_configuration\ValidationRunner.js ---

/** ValidationRunner.gs â€” Runner de validation des en-tÃªtes (CONFIG â†’ BDD â†’ TEMPLATE)
 * Ajoute un menu "Validation" dans le classeur CONFIG pour vÃ©rifier les onglets requis
 * et les en-tÃªtes attendues, en se basant STRICTEMENT sur les noms dâ€™en-tÃªtes (jamais dâ€™indices).
 * Rapport affichÃ© en sidebar (HTML).
 *
 * PRÃ‰REQUIS :
 * - Avoir les IDs des 3 classeurs :
 *    - ID_CONFIG : celui du classeur courant (dÃ©tectÃ© automatiquement)
 *    - ID_BDD, ID_TEMPLATE : soit lus dâ€™un onglet "sys_ID_Fichiers" (si prÃ©sent),
 *      soit saisis en dur ci-dessous dans FALLBACK_IDS.
 */

/** ================ CONFIGURATION MINIMALE ================ **/
const FALLBACK_IDS = {
  ID_BDD:      '1m2MGBd0nyiAl3qw032B6Nfj7zQL27bRSBexiOPaRZd8', // â† remplace si besoin
  ID_TEMPLATE: '1XwyTt9hcFLd-_IrCYuKY4_E6Dw9aUrls-AGQp65dzDU'  // â† remplace si besoin
};
// Variantes de noms acceptÃ©es pour certains onglets (tolÃ©rance orthographe/accents)
const SHEET_NAME_VARIANTS = {
  'ParamÃ¨tres GÃ©nÃ©raux': ['ParamÃ¨tres GÃ©nÃ©raux','Parametres Generaux','Parameters','ParamÃ¨tres Generaux','Parametres GÃ©nÃ©raux']
};

/** ================ MENU ================== **/
function addValidationMenu_(ui) {
  ui.createMenu('Validation')
    .addItem('VÃ©rifier les en-tÃªtes (CONFIG, BDD, TEMPLATE)', 'validateAllHeaders')
    .addToUi();
}
/** ================ HELPERS ================== **/
function normalizeHeader_(s) {
  return String(s || '')
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // retire accents
    .replace(/\s+/g, ' ') // espaces multiples â†’ un espace
    .trim()
    .toLowerCase();
}

function getHeaderRow_(sheet) {
  if (!sheet) return [];
  const lastCol = sheet.getLastColumn();
  if (lastCol === 0) return [];
  return sheet.getRange(1,1,1,lastCol).getValues()[0] || [];
}

function findSheetByVariants_(ss, canonicalName) {
  const variants = SHEET_NAME_VARIANTS[canonicalName] || [canonicalName];
  for (const name of variants) {
    const sh = ss.getSheetByName(name);
    if (sh) return sh;
  }
  return null;
}

function assertHeaders_(sheet, requiredNames, report, context) {
  const headers = getHeaderRow_(sheet);
  const normalized = headers.map(normalizeHeader_);
  const missing = requiredNames
    .map(normalizeHeader_)
    .filter(req => !normalized.includes(req));

  if (missing.length) {
    report.push({
      classeur: context.classeur,
      onglet: sheet ? sheet.getName() : context.ongletAttendu,
      type: 'En-tÃªtes manquantes',
      details: 'Manquantes: ' + missing.join(', '),
      headersTrouves: headers.join(' | ')
    });
  }
}

function getSystemIdsFromConfig_() {
  // Essaie de lire dans un onglet "sys_ID_Fichiers" (2 colonnes : ClÃ©, Valeur)
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName('sys_ID_Fichiers');
  const ids = { ID_CONFIG: ss.getId(), ID_BDD: FALLBACK_IDS.ID_BDD, ID_TEMPLATE: FALLBACK_IDS.ID_TEMPLATE };

  if (!sh) return ids;

  const values = sh.getDataRange().getValues();
  const map = {};
  values.forEach(row => {
    const k = String(row[0] || '').trim();
    const v = String(row[1] || '').trim();
    if (k && v) map[k] = v;
  });

  if (map.ID_CONFIG)   ids.ID_CONFIG = map.ID_CONFIG;
  if (map.ID_BDD)      ids.ID_BDD = map.ID_BDD;
  if (map.ID_TEMPLATE) ids.ID_TEMPLATE = map.ID_TEMPLATE;

  return ids;
}

function htmlReport_(rows) {
  const esc = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const head = `
    <style>
      body{font-family:Segoe UI,Arial,sans-serif;font-size:13px;padding:12px}
      h2{margin:0 0 10px 0}
      table{border-collapse:collapse;width:100%}
      th,td{border:1px solid #ddd;padding:6px;vertical-align:top}
      th{background:#fafafa;text-align:left}
      tr:nth-child(even){background:#fcfcfc}
      .ok{color:#2e7d32}
      .err{color:#b71c1c}
    </style>`;
  if (!rows.length) {
    return HtmlService.createHtmlOutput(head + `<h2>Validation des en-tÃªtes</h2><p class="ok">Aucune anomalie dÃ©tectÃ©e ðŸ‘</p>`)
      .setTitle('Validation en-tÃªtes');
  }
  const rowsHtml = rows.map(r => `
    <tr>
      <td>${esc(r.classeur)}</td>
      <td>${esc(r.onglet)}</td>
      <td class="err">${esc(r.type)}</td>
      <td>${esc(r.details)}</td>
      <td>${esc(r.headersTrouves || '')}</td>
    </tr>`).join('');
  const html = `
    ${head}
    <h2>Validation des en-tÃªtes</h2>
    <table>
      <thead><tr>
        <th>Classeur</th><th>Onglet</th><th>Type</th><th>DÃ©tails</th><th>En-tÃªtes trouvÃ©es</th>
      </tr></thead>
      <tbody>${rowsHtml}</tbody>
    </table>`;
  return HtmlService.createHtmlOutput(html).setTitle('Validation en-tÃªtes');
}

/** ================ RUNNER PRINCIPAL ================== **/
function validateAllHeaders() {
  const report = [];
  const { ID_CONFIG, ID_BDD, ID_TEMPLATE } = getSystemIdsFromConfig_();

  // --- CONFIG ---
  try {
    const ssCfg = SpreadsheetApp.openById(ID_CONFIG);
    const shParams = findSheetByVariants_(ssCfg, 'ParamÃ¨tres GÃ©nÃ©raux');
    if (!shParams) {
      report.push({ classeur:'CONFIG', onglet:'ParamÃ¨tres GÃ©nÃ©raux', type:'Onglet manquant', details:'Aucune variante trouvÃ©e (ParamÃ¨tres GÃ©nÃ©raux/Parametres Generaux/Parameters)' });
    } else {
      assertHeaders_(shParams, [
        'Type_Test','Repondant_Quand','Repondant_Contenu','Patron_Quand','Patron_Contenu','Formateur_Quand','Formateur_Contenu'
      ], report, { classeur:'CONFIG', ongletAttendu:'ParamÃ¨tres GÃ©nÃ©raux' });
    }
  } catch (e) {
    report.push({ classeur:'CONFIG', onglet:'*', type:'Erreur', details:String(e) });
  }

  // --- BDD ---
  try {
    const ssBdd = SpreadsheetApp.openById(ID_BDD);
    // sys_Composition_Emails
    const shCompo = ssBdd.getSheetByName('sys_Composition_Emails');
    if (!shCompo) {
      report.push({ classeur:'BDD', onglet:'sys_Composition_Emails', type:'Onglet manquant', details:'Non trouvÃ©' });
    } else {
      assertHeaders_(shCompo, [
        'Type_Test','Code_Langue','Code_Niveau_Email','Code_Profil','Element','Ordre','Contenu / ID_Document'
      ], report, { classeur:'BDD', ongletAttendu:'sys_Composition_Emails' });
    }
    // sys_PiecesJointes
    const shPJ = ssBdd.getSheetByName('sys_PiecesJointes');
    if (!shPJ) {
      report.push({ classeur:'BDD', onglet:'sys_PiecesJointes', type:'Onglet manquant', details:'Non trouvÃ©' });
    } else {
      assertHeaders_(shPJ, [
        'Type_Test','Code_Langue','Code_Niveau_Email','Code_Profil','ID_Document','Nom_Fichier'
      ], report, { classeur:'BDD', ongletAttendu:'sys_PiecesJointes' });
    }
    // Questions_META_FR (optionnel mais frÃ©quent)
    const shMeta = ssBdd.getSheetByName('Questions_META_FR');
    if (shMeta) {
      assertHeaders_(shMeta, [
        'ID_Question','Libelle','Type','Obligatoire','Bloc'
      ], report, { classeur:'BDD', ongletAttendu:'Questions_META_FR' });
    }
  } catch (e) {
    report.push({ classeur:'BDD', onglet:'*', type:'Erreur', details:String(e) });
  }

  // --- TEMPLATE ---
  try {
    const ssTpl = SpreadsheetApp.openById(ID_TEMPLATE);
    // Onglet de config attendu cÃ´tÃ© TEMPLATE (Ã  adapter si besoin)
    const shTplCfg = ssTpl.getSheetByName('sys_Template_Config');
    if (shTplCfg) {
      assertHeaders_(shTplCfg, [
        'Cle','Valeur'
      ], report, { classeur:'TEMPLATE', ongletAttendu:'sys_Template_Config' });
    } else {
      // pas bloquant : beaucoup de logique template est dans la BDD (compo emails / PJ)
      // On signale juste l'absence d'onglet de config local si on s'y attendait :
      // report.push({ classeur:'TEMPLATE', onglet:'sys_Template_Config', type:'Onglet manquant', details:'Optionnel mais recommandÃ©' });
    }
  } catch (e) {
    report.push({ classeur:'TEMPLATE', onglet:'*', type:'Erreur', details:String(e) });
  }

  // Affiche le rapport
  const out = htmlReport_(report);
  SpreadsheetApp.getUi().showSidebar(out);
}


